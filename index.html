<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo Digital Público - Debug</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
  <div class="container">
    <h1 class="titulo-pagina">Catálogo Digital Público</h1>
    <p class="subtitulo-pagina info">Selecciona una categoría para explorar productos</p>
    <div id="mensajes" class="info"></div>

    <section id="categorias" class="grid"></section>

    <section id="productos" style="display:none; margin-top:16px;">
      <button id="volver">← Volver a categorías</button>
      <h2 id="titulo-categoria"></h2>
      <div id="lista-productos" class="grid" style="margin-top:8px"></div>
    </section>
  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://dsvracququvtxofpnuar.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzdnJhY3F1cXV2dHhvZnBudWFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NTU5NDMsImV4cCI6MjA4MTEzMTk0M30.cMnyd_6oIgZt7zdxjAteZs7ay5nWrHpE-v6V-CVm2aY";

    // Inicializa correctamente desde el objeto global del CDN
    // Opción segura: tomar createClient desde el global supabase
    const { createClient } = supabase; 
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const $mensajes = document.getElementById('mensajes');

    function mostrarMensaje(msg, tipo = 'info') {
      $mensajes.innerText = msg;
      if (tipo === 'error') $mensajes.classList.add('error');
      else $mensajes.classList.remove('error');
    }

    async function cargarCategorias() {
      mostrarMensaje('Cargando categorías...');
      try {
        const res = await supabaseClient.from('categorias').select('id, nombre, imagen').order('id');
        console.log('Respuesta categorías raw:', res);
        const { data, error, status } = res;
        if (error) {
          console.error('Error al consultar categorias:', error);
          mostrarMensaje('Error cargando categorías. Mira la consola.', 'error');
          return;
        }
        if (!data || data.length === 0) {
          mostrarMensaje('No hay categorías en la base de datos. Inserta datos de prueba (SQL más abajo).');
          document.getElementById('categorias').innerHTML = '<p>No hay categorías</p>';
          return;
        }

        mostrarMensaje(`Se han cargado ${data.length} categorías.`);
        const cont = document.getElementById('categorias');
        cont.innerHTML = '';
        data.forEach(cat => {
          const card = document.createElement('div');
          card.className = 'card';
          card.style.cursor = 'pointer';
          const img = cat.imagen ? `<img src="${cat.imagen}" alt="${cat.nombre}">` : '<div style="height:90px;background:#f0f0f0;margin-bottom:8px;display:flex;align-items:center;justify-content:center">Sin imagen</div>';
          card.innerHTML = `${img}<strong>${cat.nombre}</strong>`;
          card.onclick = () => cargarProductos(cat.id, cat.nombre);
          cont.appendChild(card);
        });
      } catch (err) {
        console.error('Exception cargando categorias:', err);
        mostrarMensaje('Excepción al cargar categorías. Mira la consola.', 'error');
      }
    }

    async function cargarProductos(categoriaId, nombreCategoria = '') {
      mostrarMensaje(`Cargando productos de: ${nombreCategoria || categoriaId}...`);
      try {
        const res = await supabaseClient.from('productos')
          .select('id, nombre, precio, imagen, categoria_id')
          .eq('categoria_id', categoriaId)
          .order('id');
        console.log('Respuesta productos raw:', res);
        const { data, error } = res;
        if (error) {
          console.error('Error al consultar productos:', error);
          mostrarMensaje('Error cargando productos. Mira la consola.', 'error');
          return;
        }
        if (!data || data.length === 0) {
          mostrarMensaje('No hay productos para esta categoría.');
          document.getElementById('lista-productos').innerHTML = '<p>No hay productos</p>';
        } else {
          mostrarMensaje(`Se han cargado ${data.length} productos.`);
          const cont = document.getElementById('lista-productos');
          cont.innerHTML = '';
          data.forEach(prod => {
            const card = document.createElement('div');
            card.className = 'card';
            const img = prod.imagen ? `<img src="${prod.imagen}" alt="${prod.nombre}">` : '<div style="height:90px;background:#f0f0f0;margin-bottom:8px;display:flex;align-items:center;justify-content:center">Sin imagen</div>';
            card.innerHTML = `${img}<strong>${prod.nombre}</strong><div>Precio: $${prod.precio}</div>`;
            cont.appendChild(card);
          });
        }
        // UI
        document.getElementById('categorias').style.display = 'none';
        document.getElementById('productos').style.display = 'block';
        document.getElementById('titulo-categoria').innerText = nombreCategoria ? `Productos: ${nombreCategoria}` : 'Productos';
      } catch (err) {
        console.error('Exception cargando productos:', err);
        mostrarMensaje('Excepción al cargar productos. Mira la consola.', 'error');
      }
    }

    document.getElementById('volver').onclick = () => {
      document.getElementById('productos').style.display = 'none';
      document.getElementById('categorias').style.display = 'flex';
      document.querySelector('.subtitulo-pagina').textContent = "Selecciona una categoría para explorar productos";
      mostrarMensaje('');
    };

    // Arranque
    cargarCategorias();
  </script>
</body>
</html>